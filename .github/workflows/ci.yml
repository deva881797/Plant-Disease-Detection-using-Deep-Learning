name: CI Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly security scan on Sundays
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ============================================
  # Stage 1: Code Quality
  # ============================================
  
  lint:
    name: üîç Lint Python Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: pip install flake8 pylint

      - name: Run flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Run pylint
        run: pylint app.py model.py --exit-zero --disable=C0114,C0115,C0116,R0903

  format-check:
    name: üé® Check Code Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install formatting tools
        run: pip install black isort

      - name: Check black formatting
        run: black --check --diff app.py model.py ui.py

      - name: Check isort import ordering
        run: isort --check-only --diff app.py model.py ui.py

  type-check:
    name: üî¨ Type Checking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install mypy and stubs
        run: pip install mypy types-Pillow pandas-stubs

      - name: Run mypy
        run: mypy app.py model.py --ignore-missing-imports --no-error-summary || true

  # ============================================
  # Stage 2: Build & Runtime
  # ============================================

  docker-build:
    name: üê≥ Docker Build
    runs-on: ubuntu-latest
    needs: [lint]  # Wait for lint to pass
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate docker-compose.yml
        run: docker compose config --quiet

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: plant-disease-classifier:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  streamlit-check:
    name: üöÄ Streamlit App Validation
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Validate Python imports
        run: |
          python -c "import app; print('‚úÖ app.py imports successfully')"
          python -c "import model; print('‚úÖ model.py imports successfully')"
          python -c "import ui; print('‚úÖ ui.py imports successfully')"

      - name: Streamlit syntax check
        run: python -m py_compile app.py model.py ui.py

  # ============================================
  # Stage 3: Security & Validation
  # ============================================

  security:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install security tools
        run: pip install pip-audit bandit

      - name: Audit dependencies for vulnerabilities
        run: pip-audit -r requirements.txt --ignore-vuln PYSEC-2024-48 || true

      - name: Run bandit security linter
        run: bandit -r app.py model.py -ll --skip B101

  model-validation:
    name: ü§ñ Model Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true  # In case model is stored in Git LFS

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install TensorFlow Lite
        run: pip install tensorflow numpy pandas

      - name: Validate TFLite model
        run: |
          python -c "
          import tensorflow as tf
          import os
          
          model_path = 'prediction_model.tflite'
          
          # Check model exists
          if not os.path.exists(model_path):
              print('‚ùå Model file not found!')
              exit(1)
          
          # Check model size
          size_mb = os.path.getsize(model_path) / (1024 * 1024)
          print(f'üì¶ Model size: {size_mb:.2f} MB')
          
          # Try loading the model
          interpreter = tf.lite.Interpreter(model_path=model_path)
          interpreter.allocate_tensors()
          
          # Get input/output details
          input_details = interpreter.get_input_details()
          output_details = interpreter.get_output_details()
          
          print(f'‚úÖ Model loaded successfully')
          print(f'üì• Input shape: {input_details[0][\"shape\"]}')
          print(f'üì§ Output shape: {output_details[0][\"shape\"]}')
          "

      - name: Validate class dictionary
        run: |
          python -c "
          import pandas as pd
          
          df = pd.read_csv('Plant Village Disease-class_dict.csv')
          num_classes = len(df)
          print(f'‚úÖ Class dictionary loaded: {num_classes} classes')
          
          if num_classes != 38:
              print(f'‚ö†Ô∏è Warning: Expected 38 classes, found {num_classes}')
          "

  docs-check:
    name: üìö Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "‚ùå README.md not found!"
            exit 1
          fi
          echo "‚úÖ README.md exists"

      - name: Validate README is not empty
        run: |
          if [ ! -s "README.md" ]; then
            echo "‚ùå README.md is empty!"
            exit 1
          fi
          lines=$(wc -l < README.md)
          echo "‚úÖ README.md has $lines lines"

      - name: Check for required sections
        run: |
          echo "Checking README sections..."
          grep -qi "install\|setup\|getting started" README.md && echo "‚úÖ Installation section found" || echo "‚ö†Ô∏è No installation section"
          grep -qi "usage\|how to\|run" README.md && echo "‚úÖ Usage section found" || echo "‚ö†Ô∏è No usage section"
          grep -qi "docker" README.md && echo "‚úÖ Docker section found" || echo "‚ö†Ô∏è No Docker section"
